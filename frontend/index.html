<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Queimadas - AmazÃ´nia</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        #map {
            height: 80vh;
            width: 100%;
        }
        
        .fire-marker {
            border-radius: 50%;
            border: 2px solid #ff4444;
            background: radial-gradient(circle, #ff6666, #ff0000);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
            }
        }
        
        .stats-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
        
        .loading {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-red-800 shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold">ðŸ”¥ Monitoramento de Queimadas</h1>
                        <p class="text-red-200">AmazÃ´nia - Dados NASA FIRMS</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="status" class="flex items-center">
                            <div class="w-3 h-3 bg-green-400 rounded-full mr-2"></div>
                            <span class="text-sm">Online</span>
                        </div>
                        <button id="refreshBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-colors">
                            <span id="refreshIcon">ðŸ”„</span> Atualizar
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Stats Dashboard -->
        <div class="container mx-auto px-4 py-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="stats-card rounded-lg p-6 text-gray-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total de Focos</p>
                            <p id="totalFires" class="text-2xl font-bold text-red-600">-</p>
                        </div>
                        <div class="text-red-500 text-3xl">ðŸ”¥</div>
                    </div>
                </div>
                
                <div class="stats-card rounded-lg p-6 text-gray-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">ConfianÃ§a MÃ©dia</p>
                            <p id="avgConfidence" class="text-2xl font-bold text-blue-600">-</p>
                        </div>
                        <div class="text-blue-500 text-3xl">ðŸ“Š</div>
                    </div>
                </div>
                
                <div class="stats-card rounded-lg p-6 text-gray-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">PotÃªncia MÃ©dia</p>
                            <p id="avgFrp" class="text-2xl font-bold text-orange-600">-</p>
                        </div>
                        <div class="text-orange-500 text-3xl">âš¡</div>
                    </div>
                </div>
                
                <div class="stats-card rounded-lg p-6 text-gray-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Ãšltima AtualizaÃ§Ã£o</p>
                            <p id="lastUpdate" class="text-sm font-bold text-green-600">-</p>
                        </div>
                        <div class="text-green-500 text-3xl">ðŸ•’</div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Filtros</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Fonte do SatÃ©lite</label>
                        <select id="sourceFilter" class="w-full p-2 bg-gray-700 rounded-lg border border-gray-600">
                            <option value="">Todas as fontes</option>
                            <option value="MODIS_NRT">MODIS Near Real-Time</option>
                            <option value="VIIRS_SNPP_NRT">VIIRS Suomi-NPP</option>
                            <option value="VIIRS_NOAA20_NRT">VIIRS NOAA-20</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">ConfianÃ§a MÃ­nima (%)</label>
                        <input type="range" id="confidenceFilter" min="0" max="100" value="0" 
                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>0%</span>
                            <span id="confidenceValue">0%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">PerÃ­odo (horas)</label>
                        <select id="timeFilter" class="w-full p-2 bg-gray-700 rounded-lg border border-gray-600">
                            <option value="6">Ãšltimas 6 horas</option>
                            <option value="12">Ãšltimas 12 horas</option>
                            <option value="24" selected>Ãšltimas 24 horas</option>
                            <option value="48">Ãšltimas 48 horas</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mapa -->
        <div class="container mx-auto px-4 pb-6">
            <div class="bg-gray-800 rounded-lg overflow-hidden">
                <div id="map"></div>
            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 text-center text-gray-800">
                <div class="loading w-8 h-8 border-4 border-red-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-lg font-semibold">Carregando dados de queimadas...</p>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
        class FireMonitor {
            constructor() {
                this.map = null;
                this.fireLayer = null;
                this.apiUrl = 'http://localhost:8000'; // Ajuste conforme necessÃ¡rio
                this.refreshInterval = null;
                
                this.init();
            }
            
            async init() {
                this.initMap();
                this.setupEventListeners();
                await this.loadFireData();
                this.startAutoRefresh();
                this.hideLoading();
            }
            
            initMap() {
                // Inicializa o mapa centrado na AmazÃ´nia
                this.map = L.map('map').setView([-3, -60], 5);
                
                // Adiciona camadas base
                const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Esri, NASA FIRMS'
                });
                
                const terrain = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                });
                
                // Controle de camadas
                const baseMaps = {
                    "SatÃ©lite": satellite,
                    "Terreno": terrain
                };
                
                satellite.addTo(this.map);
                L.control.layers(baseMaps).addTo(this.map);
                
                // Inicializa grupo de marcadores para focos de queimada
                this.fireLayer = L.layerGroup().addTo(this.map);
            }
            
            setupEventListeners() {
                // BotÃ£o de atualizaÃ§Ã£o
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadFireData();
                });
                
                // Filtros
                ['sourceFilter', 'confidenceFilter', 'timeFilter'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => {
                        this.loadFireData();
                    });
                });
                
                // Slider de confianÃ§a
                document.getElementById('confidenceFilter').addEventListener('input', (e) => {
                    document.getElementById('confidenceValue').textContent = e.target.value + '%';
                });
            }
            
            async loadFireData() {
                try {
                    this.showLoading();
                    
                    // Obter valores dos filtros
                    const source = document.getElementById('sourceFilter').value;
                    const minConfidence = document.getElementById('confidenceFilter').value;
                    const hoursAgo = document.getElementById('timeFilter').value;
                    
                    // Construir URL com parÃ¢metros
                    const params = new URLSearchParams({
                        min_confidence: minConfidence,
                        hours_ago: hoursAgo
                    });
                    
                    if (source) params.append('source', source);
                    
                    // Buscar dados de queimadas
                    const fireResponse = await fetch(`${this.apiUrl}/api/fires/geojson?${params}`);
                    if (!fireResponse.ok) throw new Error('Erro ao carregar dados de queimadas');
                    
                    const fireData = await fireResponse.json();
                    
                    // Buscar estatÃ­sticas
                    const statsResponse = await fetch(`${this.apiUrl}/api/fires/stats`);
                    if (!statsResponse.ok) throw new Error('Erro ao carregar estatÃ­sticas');
                    
                    const stats = await statsResponse.json();
                    
                    // Atualizar mapa e interface
                    this.updateMap(fireData);
                    this.updateStats(stats);
                    this.updateStatus('success');
                    
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    this.updateStatus('error');
                    alert('Erro ao carregar dados: ' + error.message);
                } finally {
                    this.hideLoading();
                }
            }
            
            updateMap(geoJsonData) {
                // Limpa marcadores existentes
                this.fireLayer.clearLayers();
                
                if (!geoJsonData.features || geoJsonData.features.length === 0) {
                    return;
                }
                
                // Adiciona novos marcadores
                geoJsonData.features.forEach(feature => {
                    const coords = feature.geometry.coordinates;
                    const props = feature.properties;
                    
                    // Tamanho do marcador baseado na intensidade
                    const frp = props.frp || 0;
                    const size = Math.max(8, Math.min(20, frp / 10));
                    
                    // Cor baseada na confianÃ§a
                    const confidence = props.confidence || 0;
                    const color = confidence >= 80 ? '#ff0000' : 
                                 confidence >= 50 ? '#ff6600' : '#ffaa00';
                    
                    const marker = L.circleMarker([coords[1], coords[0]], {
                        radius: size,
                        fillColor: color,
                        color: '#ffffff',
                        weight: 1,
                        opacity: 0.8,
                        fillOpacity: 0.6
                    });
                    
                    // Popup com informaÃ§Ãµes
                    const popupContent = `
                        <div class="text-gray-800 p-2">
                            <h3 class="font-bold text-lg mb-2">ðŸ”¥ Foco de Queimada</h3>
                            <p><strong>LocalizaÃ§Ã£o:</strong> ${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}</p>
                            <p><strong>Data:</strong> ${props.acq_date} ${props.acq_time}</p>
                            <p><strong>SatÃ©lite:</strong> ${props.satellite}</p>
                            <p><strong>Fonte:</strong> ${props.source}</p>
                            <p><strong>ConfianÃ§a:</strong> ${props.confidence}%</p>
                            <p><strong>Brilho:</strong> ${props.brightness}K</p>
                            <p><strong>PotÃªncia:</strong> ${props.frp} MW</p>
                            <p><strong>PerÃ­odo:</strong> ${props.daynight === 'D' ? 'Dia' : 'Noite'}</p>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    this.fireLayer.addLayer(marker);
                });
            }
            
            updateStats(stats) {
                document.getElementById('totalFires').textContent = stats.total_fires.toLocaleString();
                document.getElementById('avgConfidence').textContent = stats.avg_confidence + '%';
                document.getElementById('avgFrp').textContent = stats.avg_fire_power.toFixed(1) + ' MW';
                
                if (stats.last_update) {
                    const lastUpdate = new Date(stats.last_update);
                    document.getElementById('lastUpdate').textContent = lastUpdate.toLocaleString('pt-BR');
                }
            }
            
            updateStatus(type) {
                const statusEl = document.getElementById('status');
                const dot = statusEl.querySelector('div');
                const text = statusEl.querySelector('span');
                
                if (type === 'success') {
                    dot.className = 'w-3 h-3 bg-green-400 rounded-full mr-2';
                    text.textContent = 'Online';
                } else {
                    dot.className = 'w-3 h-3 bg-red-400 rounded-full mr-2';
                    text.textContent = 'Erro';
                }
            }
            
            showLoading() {
                const refreshIcon = document.getElementById('refreshIcon');
                refreshIcon.innerHTML = 'ðŸ”„';
                refreshIcon.classList.add('loading');
            }
            
            hideLoading() {
                const refreshIcon = document.getElementById('refreshIcon');
                refreshIcon.classList.remove('loading');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
            
            startAutoRefresh() {
                // Atualiza a cada 5 minutos
                this.refreshInterval = setInterval(() => {
                    this.loadFireData();
                }, 5 * 60 * 1000);
            }
            
            stopAutoRefresh() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
            }
        }
        
        // Inicializa a aplicaÃ§Ã£o quando a pÃ¡gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            new FireMonitor();
        });
        
        // Cleanup quando a pÃ¡gina for fechada
        window.addEventListener('beforeunload', () => {
            if (window.fireMonitor) {
                window.fireMonitor.stopAutoRefresh();
            }
        });
    </script>
</body>
</html>